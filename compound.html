<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>複利計算器</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="assets/css/main.css" />
    <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>  
    <style>
        .tab {
            overflow: hidden;
            border-bottom: 1px solid #1c1d26;
            background-color: #1c1d26;
        }

        .tab button {
            background-color: inherit;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            color: rgb(255, 255, 255);
        }

        .tab button.active {
            background-color: #ccc;
            color: rgb(255, 255, 255);
        }

        .tabcontent {
            display: none;
            padding: 16px;
            border: 1px solid #1c1d26;
            border-top: none;
        }
    </style>
</head>
<body>
    <header id="header">
        <h1 id="logo"><a href="index.html">Jerry</a></h1>
    </header>  
    <br><br>

    <div class="tab">
        <button class="tablinks" onclick="openPage(event, 'calculator')">複利計算器</button>
        <!-- <input type="submit" class="tablinks" value="複利計算器" onclick="openPage(event, 'calculator')"> -->
        <button class="tablinks" onclick="openPage(event, 'other')">平均年化報酬率</button>
        <!-- <input type="submit" class="tablinks" value="其他功能" onclick="openPage(event, 'other')"> -->
    </div>

    <div id="calculator" class="tabcontent">
        初始投資金額：<input type="text" id="initial" placeholder="初始投資金額" value=1000000 oninput="formatNumber(this)">
        <br>
        每月加碼金額：<input type="text" id="monthly" placeholder="每月加碼金額" value=10000 oninput="formatNumber(this)">
        <br>
        年利率(%)：<input type="text" id="rate" placeholder="年利率(%)" value=10>
        <br>
        投資年數：<input type="text" id="years" placeholder="投資年數" value=20>
        <br>
        <input type="submit" value="計算" class="calculateButton" id="calculateButton">
        <h2>本金: <span id="principal"></span></h2>
        <h2>最終資產: <span id="result"></span></h2>
        <h2>報酬率: <span id="roi"></span></h2>
        <canvas id="myChart"></canvas>
    </div>

    <div id="other" class="tabcontent">
        最終報酬率(%)：<input type="text" id="final" placeholder="最終報酬率(%)" value=1234 oninput="formatNumber(this)">
        <br>
        年數：<input type="text" id="yearCnt" placeholder="年數" value=10 oninput="formatNumber(this)">
        <br>
        <input type="submit" value="計算" class="calculateCAGRButton" id="calculateCAGRButton">
        <h2>平均年化報酬率: <span id="cagr"></span></h2>
        <canvas id="myChart"></canvas>
    </div>


    <div id="other" class="tabcontent">
        <h2>其他功能</h2>
        <p>這裡可以放其他功能的內容。</p>
    </div>

    <script>
        window.onload = function() {
            // 預設打開第一個頁籤
            document.querySelector('.tab button').click();
            var button = document.getElementById('calculateButton');
            if (button) {
                button.click();
            }
        };

        let chart;
        let btnClick = document.querySelector('.calculateButton');
        let btnCAGRClick = document.querySelector('.calculateCAGRButton');

        function calculate() {
            const initial = parseFloat(document.getElementById('initial').value.replace(/,/g, ''));
            const monthly = parseFloat(document.getElementById('monthly').value.replace(/,/g, ''));
            const rate = parseFloat(document.getElementById('rate').value) / 100 / 12;
            const years = parseFloat(document.getElementById('years').value);
            const months = years * 12;
            let balance = initial;
            let totalPrincipal = initial;
            let balances = [];
            let principals = [];

            for (let i = 0; i < months; i++) {
                balance = balance * (1 + rate) + monthly;
                totalPrincipal += monthly;
                balances.push(balance);
                principals.push(totalPrincipal);
            }

            document.getElementById('result').innerText = toThousands(balance.toFixed(0));
            document.getElementById('principal').innerText = toThousands(totalPrincipal.toFixed(0));
            document.getElementById('roi').innerText = (((balance - totalPrincipal) / totalPrincipal) * 100).toFixed(0) + '%';
            drawChart(balances, principals);
        }
        
        function calculateCAGR() {
        // 總報酬率轉換成倍數
        let final = document.getElementById('final').value;
        let totalReturnMultiplier = 1 + (document.getElementById('final').value / 100);
        // 計算平均年化報酬率
        let cagr = Math.pow(totalReturnMultiplier, 1 / document.getElementById('yearCnt').value) - 1;
        document.getElementById('cagr').innerText = (cagr * 100).toFixed(2);
        }

        btnClick.addEventListener('click', function() { calculate(); });
        btnCAGRClick.addEventListener('click', function() { calculateCAGR(); });

        function toThousands(num) {
            var result = [], counter = 0;
            num = (num || 0).toString().split('');
            for (var i = num.length - 1; i >= 0; i--) {
                counter++;
                result.unshift(num[i]);
                if (!(counter % 3) && i != 0) { result.unshift(','); }
            }
            return result.join('');
        }

        function drawChart(balances, principals) {
            if (chart) {
                chart.destroy(); // 銷毀舊圖表
            }

            const ctx = document.getElementById('myChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: balances.length }, (_, i) => i + 1),
                    datasets: [
                        {
                            label: '資產變化',
                            data: balances,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            fill: false
                        },
                        {
                            label: '累積投入本金',
                            data: principals,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1,
                            fill: false
                        }
                    ]
                },
                options: {
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '月份'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)' // 設定x軸網格顏色
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '金額 (元)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)' // 設定x軸網格顏色
                            }
                        }
                    }
                }
            });
        }

        function openPage(evt, pageName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(pageName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        let lastValue = "";
        function formatNumber(input) {
            let value = input.value;
            if (value === '') {
                lastValue = '';
                return;
            }
            value = value.replace(/\D/g, '');
            if (value === lastValue) {
                return;
            }
            lastValue = value;
            value = parseInt(value, 10).toLocaleString();
            input.value = value;
        }

    </script>
</body>
</html>
