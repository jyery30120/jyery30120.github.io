<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹¼ç´éµç›¤èˆ‡è¦–è­œç·´ç¿’</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
            font-family: Arial, sans-serif;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .piano-wrapper {
            display: flex;
            justify-content: center;
            width: 100%;
            overflow-x: auto;
            padding: 20px 0;
        }
        
        .piano {
            display: flex;
            position: relative;
            margin: 0 auto;
        }
        
        .key {
            position: relative;
            width: 40px;
            height: 180px;
            border: 1px solid #000;
            border-radius: 0 0 5px 5px;
            background-color: white;
            margin: 0 1px;
            box-shadow: 0 5px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 8px;
            user-select: none;
            font-size: 12px;
        }
        
        .key.black {
            position: absolute;
            width: 24px;
            height: 110px;
            background-color: black;
            color: white;
            z-index: 1;
            font-size: 10px;
        }
        
        .key:active, .key.active {
            background-color: #eee;
        }
        
        .key.black:active, .key.black.active {
            background-color: #333;
        }
        
        .key.highlight {
            background-color: #90EE90;
        }
        
        .key.black.highlight {
            background-color: #006400;
        }
        
        .controls {
            text-align: center;
            margin-top: 20px;
            width: 100%;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .sheet-music {
            width: 300px;
            height: 200px;
            background-color: white;
            border: 1px solid #ccc;
            margin: 20px auto;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px 0;
        }
        
        .staff-line {
            height: 2px;
            background-color: black;
            width: 100%;
			position: absolute; /* Add this to enable top positioning */
            left: 0; /* Ensure the line starts from the left edge */
        }
        
        .note {
            width: 33px;
            height: 22px;
            background-color: black;
            border-radius: 50%;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .ledger-line {
            height: 4px;
            background-color: black;
            width: 50px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .clef {
            position: absolute;
            left: 10px;
            font-size: 120px;
            line-height: 0;
        }
        
        .treble-clef {
            top: 50%;
            transform: translateY(-50%);
        }

        .clef.bass-clef {
            top: 50%;
            transform: translateY(-50%);
            font-size: 120px;
        }
        
        .practice-controls {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 15px;
        }
        
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        .score-display {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .feedback {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
            height: 20px;
        }
        
        .feedback.correct {
            color: green;
        }
        
        .feedback.incorrect {
            color: red;
        }
    </style>
</head>
<body>
    <br><br>
    <div class="container">
        <h1>é‹¼ç´éµç›¤èˆ‡è¦–è­œç·´ç¿’</h1>
        
        <div class="sheet-music">
            <!-- é«˜éŸ³è­œè™Ÿ -->
            <div class="clef treble-clef">ğ„</div>
            
            <!-- äº”ç·šè­œ -->
            <div class="staff-line" style="top: 30%;"></div>
            <div class="staff-line" style="top: 40%;"></div>
            <div class="staff-line" style="top: 50%;"></div>
            <div class="staff-line" style="top: 60%;"></div>
            <div class="staff-line" style="top: 70%;"></div>
            
            <!-- éŸ³ç¬¦å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
        </div>
        
        <div class="practice-controls">
            <button id="start-practice">é–‹å§‹ç·´ç¿’</button>
            <button id="new-note">æ–°éŸ³ç¬¦</button>
            <button id="toggle-clef">åˆ‡æ›é«˜ä½éŸ³è­œ</button>
        </div>
        
        <div class="score-display">æ­£ç¢ºæ¬¡æ•¸: <span id="correct-count">0</span> | éŒ¯èª¤æ¬¡æ•¸: <span id="incorrect-count">0</span></div>
        <div class="feedback"></div>
        
        <div class="piano-wrapper">
            <div class="piano">
                <!-- ç¬¬ä¸€å€‹å…«åº¦ (C3 - B3) -->
                <div class="key" data-note="C3">C3</div>
				<div class="key black" data-note="Db3" style="left: 27px;">C#3</div>
				<div class="key" data-note="D3">D3</div>
				<div class="key black" data-note="Eb3" style="left: 75px;">D#3</div>
				<div class="key" data-note="E3">E3</div>
				<div class="key" data-note="F3">F3</div>
				<div class="key black" data-note="Gb3" style="left: 160px;">F#3</div>
				<div class="key" data-note="G3">G3</div>
				<div class="key black" data-note="Ab3" style="left: 205px;">G#3</div>
				<div class="key" data-note="A3">A3</div>
				<div class="key black" data-note="Bb3" style="left: 250px;">A#3</div>
				<div class="key" data-note="B3">B3</div>
                
                <!-- ç¬¬äºŒå€‹å…«åº¦ (C4 - B4) -->
                <div class="key" data-note="C4">C4</div>
				<div class="key black" data-note="Db4" style="left: 335px;">C#4</div>
				<div class="key" data-note="D4">D4</div>
				<div class="key black" data-note="Eb4" style="left: 385px;">D#4</div>
				<div class="key" data-note="E4">E4</div>
				<div class="key" data-note="F4">F4</div>
				<div class="key black" data-note="Gb4" style="left: 465px;">F#4</div>
				<div class="key" data-note="G4">G4</div>
				<div class="key black" data-note="Ab4" style="left: 510px;">G#4</div>
				<div class="key" data-note="A4">A4</div>
				<div class="key black" data-note="Bb4" style="left: 560px;">A#4</div>
				<div class="key" data-note="B4">B4</div>
                
                <!-- ç¬¬ä¸‰å€‹å…«åº¦ (C5 - B5) -->
                <div class="key" data-note="C5">C5</div>
				<div class="key black" data-note="Db5" style="left: 645px;">C#5</div>
				<div class="key" data-note="D5">D5</div>
				<div class="key black" data-note="Eb5" style="left: 690px;">D#5</div>
				<div class="key" data-note="E5">E5</div>
				<div class="key" data-note="F5">F5</div>
				<div class="key black" data-note="Gb5" style="left: 780px;">F#5</div>
				<div class="key" data-note="G5">G5</div>
				<div class="key black" data-note="Ab5" style="left: 825px;">G#5</div>
				<div class="key" data-note="A5">A5</div>
				<div class="key black" data-note="Bb5" style="left: 868px;">A#5</div>
				<div class="key" data-note="B5">B5</div>
            </div>
        </div>
        <div class="controls">
            <p>é»æ“Šç´éµæ’­æ”¾è²éŸ³ï¼Œæˆ–ä½¿ç”¨éµç›¤æŒ‰éµæ§åˆ¶</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // å±…ä¸­é‹¼ç´éµç›¤
            function centerPiano() {
                const pianoWrapper = document.querySelector('.piano-wrapper');
                const piano = document.querySelector('.piano');
                
                // ç¢ºä¿é‹¼ç´éµç›¤æ°´å¹³å±…ä¸­
                const wrapperWidth = pianoWrapper.offsetWidth;
                const pianoWidth = piano.offsetWidth;
                
                if (pianoWidth < wrapperWidth) {
                    piano.style.marginLeft = 'auto';
                    piano.style.marginRight = 'auto';
                } else {
                    piano.style.marginLeft = '0';
                    piano.style.marginRight = '0';
                }
            }
            
            // é é¢åŠ è¼‰æ™‚å±…ä¸­é‹¼ç´
            centerPiano();
            
            // çª—å£å¤§å°æ”¹è®Šæ™‚é‡æ–°å±…ä¸­
            window.addEventListener('resize', centerPiano);
            
            // å»ºç«‹éŸ³é »ä¸Šä¸‹æ–‡
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // è²éŸ³é »ç‡æ˜ å°„è¡¨ (å¾ C3 åˆ° B5)
            const noteFrequency = {
                // ç¬¬ä¸€å€‹å…«åº¦ (C3 - B3)
                'C3': 130.81,
                'Db3': 138.59,
                'D3': 146.83,
                'Eb3': 155.56,
                'E3': 164.81,
                'F3': 174.61,
                'Gb3': 185.00,
                'G3': 196.00,
                'Ab3': 207.65,
                'A3': 220.00,
                'Bb3': 233.08,
                'B3': 246.94,
                
                // ç¬¬äºŒå€‹å…«åº¦ (C4 - B4)
                'C4': 261.63,
                'Db4': 277.18,
                'D4': 293.66,
                'Eb4': 311.13,
                'E4': 329.63,
                'F4': 349.23,
                'Gb4': 369.99,
                'G4': 392.00,
                'Ab4': 415.30,
                'A4': 440.00,
                'Bb4': 466.16,
                'B4': 493.88,
                
                // ç¬¬ä¸‰å€‹å…«åº¦ (C5 - B5)
                'C5': 523.25,
                'Db5': 554.37,
                'D5': 587.33,
                'Eb5': 622.25,
                'E5': 659.26,
                'F5': 698.46,
                'Gb5': 739.99,
                'G5': 783.99,
                'Ab5': 830.61,
                'A5': 880.00,
                'Bb5': 932.33,
                'B5': 987.77
            };

            // **æ–°å¢è®Šæ•¸**: åˆ¤æ–·æ˜¯é«˜éŸ³è­œè™Ÿé‚„æ˜¯ä½éŸ³è­œè™Ÿ
            let useTrebleClef = true;
            
            // äº”ç·šè­œä¸Šçš„éŸ³ç¬¦ä½ç½® (åƒ…é©ç”¨æ–¼C, D, E, F, G, A, Bè‡ªç„¶éŸ³)
            const notePositions = {
                'G3': 218, // ç¬¬äºŒç·š
                'A3': 206,
                'B3': 194, // ç¬¬ä¸‰ç·š
                'C4': 182, // ä¸­å¤®C (äº”ç·šè­œä¸‹ç¬¬ä¸€æ¢åŠ ç·š)
                'D4': 170,
                'E4': 158, // ç¬¬ä¸€ç·š
                'F4': 146,
                'G4': 134, // ç¬¬äºŒç·š
                'A4': 122,
                'B4': 110, // ç¬¬ä¸‰ç·š
                'C5': 98,
                'D5': 86, // ç¬¬å››ç·š
                'E5': 74,
                'F5': 62,  // ç¬¬äº”ç·š
                'G5': 50,
                'A5': 38,
                'B5': 26
            };

            // **æ–°å¢éŸ³ç¬¦ä½ç½®**: ä½éŸ³è­œè™Ÿçš„éŸ³ç¬¦ä½ç½®
            const notePositionsBass = {
                'C3': 122,
                'D3': 110,
                'E3': 98,
                'F3': 86,
                'G3': 74,
                'A3': 62,
                'B3': 50,
                'C4': 38,
                'D4': 26,
                'E4': 14,
                'F4': 2,
            };
            
            // äº”ç·šè­œç›¸é—œè®Šé‡
            let currentNote = null;
            let score = 0;
            let practiceActive = false;
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦åŠ ç·š
            function needsLedgerLine(notePosition) {
                // è¶…å‡ºäº”ç·šè­œç¯„åœçš„éŸ³ç¬¦éœ€è¦åŠ ç·š
                return notePosition >= 180 || notePosition <= 38;
            }
            
            // ç²å–åŠ ç·šçš„ä½ç½®
            function getLedgerLinePositions(notePosition) {
                const positions = [];
                
                // ä½éŸ³éƒ¨åˆ† (äº”ç·šè­œä¸‹æ–¹)
                if (notePosition >= 180) {
                    for (let pos = 182; pos <= notePosition; pos += 24) {
                        positions.push(pos + 9);
                    }
                }
                
                // é«˜éŸ³éƒ¨åˆ† (äº”ç·šè­œä¸Šæ–¹)
                if (notePosition <= 38) { 
                    for (let pos = 38; pos >= notePosition; pos -= 24) {
                        positions.push(pos + 9);
                    }
                }
                
                return positions;
            }
            
            // ç”Ÿæˆéš¨æ©ŸéŸ³ç¬¦
            function generateRandomNote() {
                // åƒ…å¾ç™½éµéŸ³ç¬¦ä¸­é¸æ“‡ (C, D, E, F, G, A, B)
                console.log("useTrebleClef=" + useTrebleClef)
                const whiteNotes = Object.keys(useTrebleClef ? notePositions:notePositionsBass);
                const randomIndex = Math.floor(Math.random() * whiteNotes.length);
                return whiteNotes[randomIndex];
                // return whiteNotes[10];
            }
            
            // é¡¯ç¤ºéŸ³ç¬¦åœ¨äº”ç·šè­œä¸Š
            function displayNote(note) {
                // æ¸…é™¤ä¹‹å‰çš„éŸ³ç¬¦
                const existingNote = document.querySelector('.note');
                if (existingNote) {
                    existingNote.remove();
                }
                
                // æ¸…é™¤ä¹‹å‰çš„åŠ ç·š
                const existingLedgerLines = document.querySelectorAll('.ledger-line');
                existingLedgerLines.forEach(line => line.remove());
                
                const sheetMusic = document.querySelector('.sheet-music');
                const position = (useTrebleClef ?notePositions:notePositionsBass)[note];
                
                // å‰µå»ºéŸ³ç¬¦
                const noteElement = document.createElement('div');
                noteElement.className = 'note';
                noteElement.style.top = position + 'px';
                sheetMusic.appendChild(noteElement);
                
                // å¦‚æœéœ€è¦åŠ ç·š
                if (needsLedgerLine(position)) {
                    const ledgerLinePositions = getLedgerLinePositions(position);
                    
                    // æ·»åŠ æ¯ä¸€æ¢éœ€è¦çš„åŠ ç·š
                    ledgerLinePositions.forEach(linePos => {
                        const ledgerLine = document.createElement('div');
                        ledgerLine.className = 'ledger-line';
                        ledgerLine.style.top = linePos + 'px';
                        sheetMusic.appendChild(ledgerLine);
                    });
                }
                
                // ä¿å­˜ç•¶å‰éŸ³ç¬¦
                currentNote = note;
            }
            
            // é¡¯ç¤ºåé¥‹è¨Šæ¯
            function showFeedback(isCorrect) {
                const feedback = document.querySelector('.feedback');
                feedback.textContent = isCorrect ? 'æ­£ç¢º!' : 'éŒ¯èª¤ï¼Œè«‹é‡è©¦!';
                feedback.className = 'feedback ' + (isCorrect ? 'correct' : 'incorrect');
                
                // 3ç§’å¾Œæ¸…é™¤åé¥‹
                setTimeout(() => {
                    feedback.textContent = '';
                    feedback.className = 'feedback';
                }, 2000);
            }
            
            // æ›´æ–°åˆ†æ•¸
            function updateScore(points) {
                score += points;
                document.querySelector('.score-display').textContent = `åˆ†æ•¸: ${score}`;
            }

            function updateCounts(isCorrect) {
                if (isCorrect) {
                    correctCount++;
                    document.getElementById('correct-count').textContent = correctCount;
                } else {
                    incorrectCount++;
                    document.getElementById('incorrect-count').textContent = incorrectCount;
                }
            }
            
            // æª¢æŸ¥ç”¨æˆ¶æŒ‰ä¸‹çš„éŸ³ç¬¦æ˜¯å¦æ­£ç¢º
            function checkNote(playedNote) {
                if (!practiceActive || !currentNote) return;
                
                if (playedNote === currentNote) {
                    // æ­£ç¢º
                    showFeedback(true);
                    updateCounts(true);
                    
                    // é«˜äº®æ­£ç¢ºçš„éµ
                    const key = document.querySelector(`.key[data-note="${currentNote}"]`);
                    key.classList.add('highlight');
                    
                    // çŸ­æš«å»¶é²å¾Œç”Ÿæˆæ–°éŸ³ç¬¦
                    setTimeout(() => {
                        key.classList.remove('highlight');
                        generateNewNote();
                    }, 500);
                } else {
                    // éŒ¯èª¤
                    showFeedback(false);
                    updateCounts(false);
                }
            }
            
            // ç”Ÿæˆæ–°çš„éŸ³ç¬¦
            function generateNewNote() {
                if (!practiceActive) return;
                
                const newNote = generateRandomNote();
                console.log("newNote=" + newNote)
                displayNote(newNote);
            }

            function toggleClef() {
                useTrebleClef = !useTrebleClef;
                const clefElement = document.querySelector('.clef');
                clefElement.textContent = useTrebleClef ? 'ğ„' : 'ğ„¢'; // é«˜éŸ³è­œè™Ÿ : ä½éŸ³è­œè™Ÿ
                clefElement.className = useTrebleClef ? 'clef treble-clef' : 'clef bass-clef'; // æ›´æ”¹ Class

                //  æ¯æ¬¡åˆ‡æ›æ™‚éƒ½é‡æ–°ç”Ÿæˆä¸€å€‹æ–°çš„éŸ³ç¬¦
                generateNewNote();
            }
            
            // é–‹å§‹ç·´ç¿’æŒ‰éˆ•
            document.getElementById('start-practice').addEventListener('click', function() {
                practiceActive = true;
                correctCount = 0;
                incorrectCount = 0;
                
                // åˆå§‹åŒ–éŸ³é »ä¸Šä¸‹æ–‡ï¼ˆè§£æ±ºæŸäº›ç€è¦½å™¨éœ€è¦ç”¨æˆ¶äº¤äº’æ‰èƒ½æ’­æ”¾è²éŸ³çš„å•é¡Œï¼‰
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                generateNewNote();
            });
            
            // æ–°éŸ³ç¬¦æŒ‰éˆ•
            document.getElementById('new-note').addEventListener('click', function() {
                if (!practiceActive) return;
                generateNewNote();
            });

            document.getElementById('toggle-clef').addEventListener('click', function() {
                toggleClef();
            });;
            
            // æ’­æ”¾éŸ³ç¬¦å‡½æ•¸
            function playNote(frequency) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.value = frequency;
                gainNode.gain.value = 0.3;
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start();
                
                // è¨­ç½®æ·¡å‡ºæ•ˆæœ
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1.5);
                
                // 1.5ç§’å¾Œåœæ­¢
                setTimeout(() => {
                    oscillator.stop();
                }, 1500);
                
                return oscillator;
            }
            
            // ç‚ºæ‰€æœ‰éµæ·»åŠ äº‹ä»¶ç›£è½å™¨
            const keys = document.querySelectorAll('.key');
            
            keys.forEach(key => {
                key.addEventListener('mousedown', function() {
                    const note = this.getAttribute('data-note');
                    const frequency = noteFrequency[note];
                    
                    // æ·»åŠ æ´»èºç‹€æ…‹
                    this.classList.add('active');
                    
                    // åˆå§‹åŒ–éŸ³é »ä¸Šä¸‹æ–‡ï¼ˆè§£æ±ºæŸäº›ç€è¦½å™¨éœ€è¦ç”¨æˆ¶äº¤äº’æ‰èƒ½æ’­æ”¾è²éŸ³çš„å•é¡Œï¼‰
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    
                    // æ’­æ”¾éŸ³ç¬¦
                    playNote(frequency);
                    
                    // æª¢æŸ¥æ˜¯å¦æ˜¯æ­£ç¢ºçš„éŸ³ç¬¦
                    checkNote(note);
                });
                
                key.addEventListener('mouseup', function() {
                    this.classList.remove('active');
                });
                
                key.addEventListener('mouseleave', function() {
                    this.classList.remove('active');
                });
            });
            
            // éµç›¤æ§åˆ¶ - ç¬¬ä¸€å€‹å…«åº¦ (æ•¸å­—éµ)
            const keyMapOctave1 = {
                '1': 'C3',
                '!': 'Db3',
                '2': 'D3',
                '@': 'Eb3',
                '3': 'E3',
                '4': 'F3',
                '$': 'Gb3',
                '5': 'G3',
                '%': 'Ab3',
                '6': 'A3',
                '^': 'Bb3',
                '7': 'B3'
            };
            
            // éµç›¤æ§åˆ¶ - ç¬¬äºŒå€‹å…«åº¦ (å­—æ¯éµ)
            const keyMapOctave2 = {
                'a': 'C4',
                'w': 'Db4',
                's': 'D4',
                'e': 'Eb4',
                'd': 'E4',
                'f': 'F4',
                't': 'Gb4',
                'g': 'G4',
                'y': 'Ab4',
                'h': 'A4',
                'u': 'Bb4',
                'j': 'B4'
            };
            
            // éµç›¤æ§åˆ¶ - ç¬¬ä¸‰å€‹å…«åº¦ (ZXCV å€åŸŸ)
            const keyMapOctave3 = {
                'z': 'C5',
                'q': 'Db5',
                'x': 'D5',
                'r': 'Eb5',
                'c': 'E5',
                'v': 'F5',
                'i': 'Gb5',
                'b': 'G5',
                'o': 'Ab5',
                'n': 'A5',
                'p': 'Bb5',
                'm': 'B5'
            };
            
            // åˆä½µæ‰€æœ‰éµç›¤æ˜ å°„
            const keyMap = {...keyMapOctave1, ...keyMapOctave2, ...keyMapOctave3};
            
            // è¼¸å‡ºéµç›¤æ˜ å°„åˆ°æ§åˆ¶å°ï¼Œè®“ç”¨æˆ¶çŸ¥é“å¦‚ä½•ä½¿ç”¨éµç›¤æ§åˆ¶
            console.log("éµç›¤æ§åˆ¶æ˜ å°„ï¼š", keyMap);
            
            document.addEventListener('keydown', function(event) {
                if (event.repeat) return; // é¿å…é•·æŒ‰é‡è¤‡è§¸ç™¼
                
                const note = keyMap[event.key];
                if (note) {
                    const key = document.querySelector(`.key[data-note="${note}"]`);
                    if (key) {
                        key.dispatchEvent(new MouseEvent('mousedown'));
                    }
                }
            });
            
            document.addEventListener('keyup', function(event) {
                const note = keyMap[event.key];
                if (note) {
                    const key = document.querySelector(`.key[data-note="${note}"]`);
                    if (key) {
                        key.dispatchEvent(new MouseEvent('mouseup'));
                    }
                }
            });
        });
    </script>
</body>
</html>